using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.Data.SqlClient;

namespace NSW
{
    public partial class _Default : System.Web.UI.Page
    {
        private SqlConnection defConn = new SqlConnection(NSW.Info.ConnectionInfo.ConnectionString);
        private SqlCommand defComm;
        private DataTable ButtonList = new DataTable("CategoryList");
        private DataColumn CategoryTitle = new DataColumn("CategoryTitle");
        private DataColumn CategoryDesc = new DataColumn("CategoryDescription");
        private DataColumn CategoryID = new DataColumn("CategoryID");
        private DataTable ButtonListLeft = new DataTable("CategoryList");
        private DataColumn CategoryTitleLeft = new DataColumn("CategoryTitle");
        private DataColumn CategoryDescLeft = new DataColumn("CategoryDescription");
        private DataColumn CategoryIDLeft = new DataColumn("CategoryID");
        private DataTable ButtonListRight = new DataTable("CategoryList");
        private DataColumn CategoryTitleRight = new DataColumn("CategoryTitle");
        private DataColumn CategoryDescRight = new DataColumn("CategoryDescription");
        private DataColumn CategoryIDRight = new DataColumn("CategoryID");


        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    ButtonList.Columns.Add(CategoryID);
                    ButtonList.Columns.Add(CategoryTitle);
                    ButtonList.Columns.Add(CategoryDesc);
                    // now get the info
                    defComm = defConn.CreateCommand();
                    defComm.CommandType = CommandType.Text;
                    defComm.CommandText = "Select * from tblPostCategories";
                    SqlDataAdapter adap = new SqlDataAdapter(defComm);
                    DataSet ds = new DataSet();
                    defConn.Open();
                    adap.Fill(ds);
                    defConn.Close();
                    foreach (DataRow dr in ds.Tables[0].Rows)
                    {
                        // grab a count of posts for the category
                        defComm.CommandText = "Select count(*) from tblPosts where fldPost_CategoryID=" + dr["fldPostCategory_id"].ToString();
                        defConn.Open();
                        object numOfPosts = defComm.ExecuteScalar();
                        defConn.Close();
                        DataRow newRow = ButtonList.NewRow();
                        int id = Convert.ToInt32(dr["fldPostCategory_id"]);
                        newRow["CategoryID"] = id;
                        string title = NSW.Data.PostCategory.Title(id);
                        int padTotal = 300 - numOfPosts.ToString().Length;
                        newRow["CategoryTitle"] = title.PadRight(padTotal, ' ') + numOfPosts.ToString();
                        newRow["CategoryDescription"] = NSW.Data.PostCategory.Description(id);
                        ButtonList.Rows.Add(newRow);
                        ButtonList.AcceptChanges();
                    }
                    NSW.Data.Cache.Add("ButtonList", ButtonList);
                    // bind the data to the repeater
                    this.splitButtonList();
                    BindButtonListLeft();
                    BindButtonListRight();
                }
            }
            catch (Exception x)
            {
                Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "Default.Page_Load", x, LogEnum.Critical);
            }
        }

        protected void CategoryList_ItemCommand(object source, RepeaterCommandEventArgs e)
        {
            if (e.CommandName == "Launch")
            {
                int id = Convert.ToInt32((e.Item.FindControl("CategoryID") as HiddenField).Value);
                Response.Redirect("~/Posts/PostList.aspx?catID=" + id.ToString());
            }
        }

        private void BindButtonListLeft()
        {
            this.CategoryListLeft.DataSource = ButtonListLeft;
            this.CategoryListLeft.DataBind();
            foreach (RepeaterItem item in CategoryListLeft.Items)
            {
                HiddenField hidden = (HiddenField)item.FindControl("CategoryID");
                hidden.Value = ButtonListLeft.Rows[item.ItemIndex]["CategoryID"].ToString();
                Button but = (Button)item.FindControl("CategoryButton");
                but.Text = ButtonListLeft.Rows[item.ItemIndex]["CategoryTitle"].ToString();
                Label lab = (Label)item.FindControl("CategoryDescription");
                lab.Text = ButtonListLeft.Rows[item.ItemIndex]["CategoryDescription"].ToString();
            }
        }

        private void BindButtonListRight()
        {
            this.CategoryListRight.DataSource = ButtonListRight;
            this.CategoryListRight.DataBind();
            foreach (RepeaterItem item in CategoryListRight.Items)
            {
                HiddenField hidden = (HiddenField)item.FindControl("CategoryID");
                hidden.Value = ButtonListRight.Rows[item.ItemIndex]["CategoryID"].ToString();
                Button but = (Button)item.FindControl("CategoryButton");
                but.Text = ButtonListRight.Rows[item.ItemIndex]["CategoryTitle"].ToString();
                Label lab = (Label)item.FindControl("CategoryDescription");
                lab.Text = ButtonListRight.Rows[item.ItemIndex]["CategoryDescription"].ToString();
            }
        }

        private void splitButtonList()
        {
            // build the two tables
            // left
            ButtonListLeft.Columns.Add(this.CategoryIDLeft);
            ButtonListLeft.Columns.Add(this.CategoryTitleLeft);
            ButtonListLeft.Columns.Add(this.CategoryDescLeft);
            // right
            ButtonListRight.Columns.Add(this.CategoryIDRight);
            ButtonListRight.Columns.Add(this.CategoryTitleRight);
            ButtonListRight.Columns.Add(this.CategoryDescRight);
            // now split the list between the two lists.
            for (int i = 0; i <= ButtonList.Rows.Count - 1; i=i+2)
            {
                DataRow leftRow = ButtonListLeft.NewRow();
                leftRow[0] = ButtonList.Rows[i][0];
                leftRow[1] = ButtonList.Rows[i][1];
                leftRow[2] = ButtonList.Rows[i][2];
                ButtonListLeft.Rows.Add(leftRow);
                ButtonListLeft.AcceptChanges();
                if (ButtonList.Rows[i + 1] != null)
                {
                    DataRow rightRow = ButtonListRight.NewRow();
                    rightRow[0] = ButtonList.Rows[i + 1][0];
                    rightRow[1] = ButtonList.Rows[i + 1][1];
                    rightRow[2] = ButtonList.Rows[i + 1][2];
                    ButtonListRight.Rows.Add(rightRow);
                    ButtonListRight.AcceptChanges();
                }
            }

        }


    }
}
