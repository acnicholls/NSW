using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.Data.SqlClient;

namespace NSW
{
    public partial class Search : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            NSW.Data.Cache.Remove("SearchCategories");
            NSW.Data.Cache.Remove("SearchTitle");
            NSW.Data.Cache.Remove("SearchDescription");
            LoadLabelValues();
            LoadListBox();
        }

        private void LoadLabelValues()
        {
            this.SearchPageTitle.Text = NSW.Data.LabelText.Text("Search.SearchPageTitle");
            this.SearchInstructions.Text = NSW.Data.LabelText.Text("Search.SearchInstructions");
            (this.SearchWizardStep0.FindControl("SearchCategoryPickerLabel") as Label).Text = NSW.Data.LabelText.Text("Search.SearchCategoryPickerLabel");
            (this.SearchWizardStep0.FindControl("SearchPostTitleLabel") as Label).Text = NSW.Data.LabelText.Text("Search.SearchPostTitleLabel");
            (this.SearchWizardStep0.FindControl("SearchPostDescriptionLabel") as Label).Text = NSW.Data.LabelText.Text("Search.SearchPostDescriptionLabel");
            (Global.GetControlFromWizard(this.SearchWizard, WizardNavigationTempContainer.FinishNavigationTemplateContainerID, "FinishButton") as Button).Text = NSW.Data.LabelText.Text("Search.FinishButton");
        }

        protected void FinishClick(object sender, WizardNavigationEventArgs e)
        {
            if (this.SearchCategoryPicker.SelectedIndex > -1 | this.SearchPostTitle.Text.Length > 0 | this.SearchPostDescription.Text.Length > 0)
            {
                if (this.SearchCategoryPicker.SelectedIndex > -1)
                {
                    string strCat = "";
                    int[] cats = this.SearchCategoryPicker.GetSelectedIndices();
                    foreach (int i in cats)
                    {
                        ListItem item = SearchCategoryPicker.Items[i];
                        strCat += item.Value + ",";
                    }
                    strCat = strCat.Substring(0, strCat.Length - 1);
                    NSW.Data.Cache.Add("SearchCategories", strCat);
                }
                if (this.SearchPostTitle.Text.Length > 0)
                {
                    NSW.Data.Cache.Add("SearchTitle", this.SearchPostTitle.Text.Trim());
                }
                if (this.SearchPostDescription.Text.Length > 0)
                    NSW.Data.Cache.Add("SearchDescription", this.SearchPostDescription.Text.Trim());
                Response.Redirect("~/Posts/PostList.aspx?func=search", true);
            }
            else
            {
                this.SearchErrorMessage.Text = NSW.Data.LabelText.Text("Search.SearchErrorMessage");
                e.Cancel = true;
            }
        }

        private void LoadListBox()
        {
            SqlConnection searchConn = new SqlConnection(NSW.Info.ConnectionInfo.ConnectionString);
            SqlCommand searchComm = searchConn.CreateCommand();
            searchComm.CommandType = CommandType.Text;
            searchComm.CommandText = "Select * from tblPostCategories order by fldPostCategory_id";
            SqlDataAdapter adap = new SqlDataAdapter(searchComm);
            DataSet ds = new DataSet();
            searchConn.Open();
            adap.Fill(ds);
            searchConn.Close();
            foreach (DataRow dr in ds.Tables[0].Rows)
            {
                NSW.Data.PostCategory cat = new Data.PostCategory(Convert.ToInt32(dr["fldPostCategory_id"]));
                ListItem item = new ListItem(NSW.Data.PostCategory.Title(cat.ID), cat.ID.ToString());
                this.SearchCategoryPicker.Items.Add(item);
            }
        }
    }
}
