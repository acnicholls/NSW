using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Security;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Data;
using System.Data.SqlClient;

namespace NSW.Account
{
    public partial class Register : System.Web.UI.Page
    {
        NSW.Data.User newUser;
        NSW.Data.Security.MembershipProvider Membership = new Data.Security.MembershipProvider();

        protected void Page_Load(object sender, EventArgs e)
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "Register.Page_Load", "Here", LogEnum.Debug);
            SqlConnection regConn = new SqlConnection(NSW.Info.ConnectionInfo.ConnectionString);
            SqlCommand regComm = regConn.CreateCommand();
            regComm.CommandType = CommandType.Text;
            regComm.CommandText = "Select fldPostal_Code from tblPostalCodes";
            DataSet ds = new DataSet();
            SqlDataAdapter adap = new SqlDataAdapter(regComm);
            regConn.Open();
            adap.Fill(ds);
            regConn.Close();
            this.PostalCode.DataSource = ds.Tables[0];
           // this.PostalCode.DataMember = ds.Tables[0].Columns[0].ColumnName;
            this.PostalCode.DataTextField = ds.Tables[0].Columns[0].ColumnName;
            DataBind();
            if (IsPostBack)
            {
                NSW.Data.User cacheUser = (NSW.Data.User)Cache["User"];
                if (cacheUser != null)
                    newUser = cacheUser;
                else
                    newUser = new Data.User();
            }
            else
                newUser = new Data.User();
        }

        protected void RegisterUser_CreatedUser(object sender, EventArgs e)
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "Register.RegisterUser_CreatedUser", "Here", LogEnum.Debug);
            // now log the user in
            FormsAuthentication.SetAuthCookie(newUser.Name, false /* createPersistentCookie */);
            string continueUrl = Request.QueryString["ReturnUrl"];
            if (String.IsNullOrEmpty(continueUrl))
            {
                continueUrl = "~/";
            }
            Response.Redirect(continueUrl);
        }

        protected void PreviousClick(object sender, WizardNavigationEventArgs e)  
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "Register.PreviousClick", "Here", LogEnum.Debug);
            // go back one screen.
        }

        protected void FinishClick(object sender, WizardNavigationEventArgs e)  
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "Register.FinishClick", "Here", LogEnum.Debug);
            string errorMessage = "";
            bool valid = true;
            // grab screen values
            TextBox phone = (TextBox)RegisterUser.ActiveStep.FindControl("PhoneNumber");
            DropDownList postal = (DropDownList)RegisterUser.ActiveStep.FindControl("PostalCode");
            // test screen values
            string phoneNumber = phone.Text;
            phoneNumber = phoneNumber.Replace(" ", string.Empty);
            if (phoneNumber.Length > 0)
            {
                if (phoneNumber.Length == 10 | phoneNumber.Length == 11)
                {   }
                else
                {
                    errorMessage = "Please enter a valid phone number";  // grab from database, english or japanese
                    valid = false;
                }
            }
            if (valid)
            {
                // add the values to the cahced user and save to db
                newUser.Phone = phone.Text.Trim();
                newUser.PostalCode = postal.SelectedItem.Text.Trim();
                Cache["User"] = newUser;
                newUser.insertUser();
                RegisterUser_CreatedUser(sender, EventArgs.Empty);
            }
            else
            {
                this.Step1ErrorMessage.Text = errorMessage;
                e.Cancel = true;
            }
        }

        protected void NextClick(object sender, WizardNavigationEventArgs e)    
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "Register.NextClick", "Here", LogEnum.Debug);
            string errorMessage = "";
            bool valid = true;
            // grab screen values
            TextBox username = (TextBox)RegisterUser.ActiveStep.FindControl("UserName");
            TextBox password = (TextBox)RegisterUser.ActiveStep.FindControl("Password");
            TextBox email = (TextBox)RegisterUser.ActiveStep.FindControl("Email");
            // test the values
            if (NSW.Data.User.Exists(username.Text, ""))
            {
                errorMessage += "The name you selected is already in use by another user.\r\n";
                valid = false;
            }
            if (NSW.Data.User.Exists("", email.Text))
            {
                errorMessage += "The email you entered is already in use. Try recovering the password.\r\n";
                valid = false;
            }
            if (password.Text.Length < Membership.MinRequiredPasswordLength)
            {
                errorMessage += "Password must be at least " + Membership.MinRequiredPasswordLength.ToString() + " characters.";
                valid = false;
            }
            if (valid)
            {
                // add the values to the user object and cache it
                newUser.Name = username.Text.Trim();
                newUser.Password = password.Text.Trim();
                newUser.Email = email.Text.Trim();
                Cache["User"] = newUser;
            }
            else
            {
                this.Step1ErrorMessage.Text = errorMessage;
                e.Cancel = true;
            }
        }
    }
}
