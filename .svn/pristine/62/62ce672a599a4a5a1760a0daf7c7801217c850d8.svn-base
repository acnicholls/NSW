using System;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace NSW.Posts
{
    public partial class AddPost : PageBase
    {
        DirectoryInfo photoFolder;
        protected void Page_Load(object sender, EventArgs e)
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.Page_Load", "Starting...", LogEnum.Debug);
            if (!IsPostBack)
            {
                LoadLabelValues();
                LoadDropDownList();
            }
        }

        private void LoadDropDownList()
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.LoadDropDownList", "Starting...", LogEnum.Debug);
            SqlConnection catConn = new SqlConnection(NSW.Info.ConnectionInfo.ConnectionString);
            SqlCommand catComm = catConn.CreateCommand();
            catComm.CommandType = CommandType.Text;
            catComm.CommandText = "Select fldPostCategory_id from tblPostCategories order by fldPostCategory_id";
            SqlDataAdapter adap = new SqlDataAdapter(catComm);
            DataSet ds = new DataSet();
            catConn.Open();
            adap.Fill(ds);
            catConn.Close();
            ListItem selectOne = new ListItem(NSW.Data.LabelText.Text("SelectOne"), "NoValue");
            this.PostCategoryPicker.Items.Add(selectOne);
            foreach(DataRow dr in ds.Tables[0].Rows)
            {
                ListItem item = new ListItem(NSW.Data.PostCategory.Title(Convert.ToInt32(dr["fldPostCategory_id"])), dr["fldPostCategory_id"].ToString());
                this.PostCategoryPicker.Items.Add(item);
            }
        }

        private void LoadLabelValues()
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.LoadLabelValues", "Starting...", LogEnum.Debug);
            this.AddPostPageTitle.Text = NSW.Data.LabelText.Text("AddPost.AddPostPageTitle");
            this.AddPostInstructions.Text = NSW.Data.LabelText.Text("AddPost.AddPostInstructions");
            // now the wizard controls
            (this.AddPostWizardStep0.FindControl("PostCategoryPickerLabel") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostCategoryPickerLabel");
            (this.AddPostWizardStep0.FindControl("PostCategoryRequired") as RequiredFieldValidator).ErrorMessage = NSW.Data.LabelText.Text("AddPost.PostCategoryRequired");
            (this.AddPostWizardStep0.FindControl("PostTitleLabel") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostTitleLabel");
            (this.AddPostWizardStep0.FindControl("PostTitleRequired") as RequiredFieldValidator).ErrorMessage = NSW.Data.LabelText.Text("AddPost.PostTitleRequired");
            (this.AddPostWizardStep0.FindControl("PostDescriptionLabel") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostDescriptionLabel");
            (this.AddPostWizardStep0.FindControl("PostDescriptionRequired") as RequiredFieldValidator).ErrorMessage = NSW.Data.LabelText.Text("AddPost.PostDescriptionRequired");
            (this.AddPostWizardStep0.FindControl("PostPriceLabel") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostPriceLabel");
            (this.AddPostWizardStep0.FindControl("PostPriceRequired") as RequiredFieldValidator).ErrorMessage = NSW.Data.LabelText.Text("AddPost.PostPriceRequired");
            (this.AddPostWizardStep0.FindControl("PostPhoto1FileContent") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostPhotoErrorMessage");
            (this.AddPostWizardStep0.FindControl("PostPhoto2FileContent") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostPhotoErrorMessage");
            (this.AddPostWizardStep0.FindControl("PostPhoto3FileContent") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostPhotoErrorMessage");
            (this.AddPostWizardStep0.FindControl("PostPhoto4FileContent") as Label).Text = NSW.Data.LabelText.Text("AddPost.PostPhotoErrorMessage");
            (Global.GetControlFromWizard(this.AddPostWizard, WizardNavigationTempContainer.FinishNavigationTemplateContainerID, "FinishButton") as Button).Text = NSW.Data.LabelText.Text("AddPost.FinishButton");
        }

        protected void FinishClick(object sender, WizardNavigationEventArgs e)
        {
            try
            {
                Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", "Starting...", LogEnum.Debug);
                bool valid = true;
                if (this.PostCategoryPicker.SelectedIndex == -1)
                {
                    this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.PostCategoryRequired");
                    valid = false;
                }
                this.Captcha1.ValidateCaptcha(this.txtCaptcha.Text.Trim());
                if (!Captcha1.UserValidated)
                {
                    this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.BadCaptcha");
                    valid = false;
                }
                if (!IsNumber(this.PostPrice.Text))
                {
                    this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.PriceNumber");
                    valid = false;
                }
                if (this.PostPhoto1.HasFile)
                {
                    if (!IsFileValid(this.PostPhoto1))
                        valid = false;
                }
                if (this.PostPhoto2.HasFile)
                {
                    if (!IsFileValid(this.PostPhoto2))
                        valid = false;
                }
                if (this.PostPhoto3.HasFile)
                {
                    if (!IsFileValid(this.PostPhoto3))
                        valid = false;
                }
                if (this.PostPhoto4.HasFile)
                {
                    if (!IsFileValid(this.PostPhoto4))
                        valid = false;
                }

                if (valid)
                {
                    NSW.Data.Post newPost = new Data.Post();
                    newPost.CategoryID = Convert.ToInt32(this.PostCategoryPicker.SelectedItem.Value);
                    newPost.Description = this.PostDescription.Text.Trim();
                    newPost.Title = this.PostTitle.Text.Trim();
                    newPost.Price = Convert.ToDecimal(this.PostPrice.Text.Trim());
                    Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", "UserName : " + Page.User.Identity.Name.ToString(), LogEnum.Debug);
                    NSW.Data.User postUser = new Data.User(Page.User.Identity.Name);
                    newPost.UserID = postUser.ID;
                    newPost.insertPost();
                    // now add photos to Photo folder
                    if (this.PostPhoto1.HasFile || this.PostPhoto2.HasFile || this.PostPhoto3.HasFile || this.PostPhoto4.HasFile)
                    {
                        DirectoryInfo folder = new DirectoryInfo(Server.MapPath("~/Posts/Photos"));
                        photoFolder = folder.CreateSubdirectory(newPost.ID.ToString());
                    }
                    if (this.PostPhoto1.HasFile)
                    {
                        string filename = "";
                        if(IsMobileDevice)
                         filename = photoFolder.FullName + @"\1" + this.PostPhoto1.FileName;
                        else
                         filename = photoFolder.FullName + @"\" + this.PostPhoto1.FileName;

                        Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", "Saving file 1 as : " + filename, LogEnum.Debug);

                        this.PostPhoto1.SaveAs(filename);
                    }
                    if (this.PostPhoto2.HasFile)
                    {
                        string filename = "";
                        if (IsMobileDevice)
                            filename = photoFolder.FullName + @"\2" + this.PostPhoto2.FileName;
                        else
                            filename = photoFolder.FullName + @"\" + this.PostPhoto2.FileName;
                        Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", "Saving file 2 as : " + filename, LogEnum.Debug);

                        this.PostPhoto2.SaveAs(filename);
                    }
                    if (this.PostPhoto3.HasFile)
                    {
                        string filename = "";
                        if (IsMobileDevice)
                            filename = photoFolder.FullName + @"\3" + this.PostPhoto3.FileName;
                        else
                            filename = photoFolder.FullName + @"\" + this.PostPhoto3.FileName;
                        Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", "Saving file 3 as : " + filename, LogEnum.Debug);

                        this.PostPhoto3.SaveAs(filename);
                    }
                    if (this.PostPhoto4.HasFile)
                    {
                        string filename = "";
                        if (IsMobileDevice)
                            filename = photoFolder.FullName + @"\4" + this.PostPhoto4.FileName;
                        else
                            filename = photoFolder.FullName + @"\" + this.PostPhoto4.FileName;
                        Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", "Saving file 4 as : " + filename, LogEnum.Debug);

                        this.PostPhoto4.SaveAs(filename);
                    }
                    if (newPost.ID > 0)
                        Response.Redirect("AddPostSuccess.aspx", false);
                    else
                        Response.Redirect("AddPostFailure.aspx", false);
                    Context.ApplicationInstance.CompleteRequest();
                }
            }
            catch (Exception x)
            {
                Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.FinishClick", x, LogEnum.Debug);
            }
        }

        private bool IsFileValid(FileUpload itemToCheck)
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.IsFileValid", "Starting...", LogEnum.Debug);

            bool valid = true;
            if (itemToCheck.FileContent.Length > 4194304)
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.4MegMessage");
            }
            if (itemToCheck.FileName.Contains("*"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains("&"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains("%"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains("\\"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains("?"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains(":"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains("<"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            if (itemToCheck.FileName.Contains(">"))
            {
                valid = false;
                this.AddPostErrorMessage.Text = NSW.Data.LabelText.Text("AddPost.FileNameMessage");
            }
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "AddPost.IsFileValid", "Done, returning : " + valid.ToString(), LogEnum.Debug);

            return valid;
        }

        private bool IsNumber(string input)
        {
            try
            {
                Convert.ToInt32(input);
                return true;
            }
            catch (Exception)
            {
                return false;
            }
        }
    }
}