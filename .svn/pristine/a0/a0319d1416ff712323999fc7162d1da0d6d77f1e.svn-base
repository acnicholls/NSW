using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Web.Security;

namespace NSW
{
    public partial class SiteMaster : System.Web.UI.MasterPage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            //// check if user was previously and persistently logged in
            ////FormsIdentity fUser = (FormsIdentity)HttpContext.Current.User.Identity;
            //if (HttpContext.Current.User.Identity.IsAuthenticated)
            //{
            //    //HttpCookie ck = Request.Cookies[FormsAuthentication.FormsCookieName];                             
            //    //if (ck != null)
            //    //{
            //        //FormsAuthenticationTicket tkt = FormsAuthentication.Decrypt(ck.Value);
            //        //string userName = tkt.Name;
            //        NSW.Data.User sesUser = new Data.User(HttpContext.Current.User.Identity.Name);
            //        //tkt = FormsAuthentication.RenewTicketIfOld(tkt); 
            //        //FormsAuthentication.SetAuthCookie(tkt.Name, tkt.IsPersistent);
            //        Cache["User"] = sesUser;
            //    //}
            //}
            //create labelText objects
            NSW.Data.LabelText title = new NSW.Data.LabelText("lblTitle");
            NSW.Data.LabelText login = new NSW.Data.LabelText("lblLogin");
            NSW.Data.LabelText welcome = new NSW.Data.LabelText("lblWelcome");
            NSW.Data.LabelText search = new NSW.Data.LabelText("btnSearch");
            NSW.Data.LabelText home = new NSW.Data.LabelText("btnHome");
            NSW.Data.LabelText logout = new NSW.Data.LabelText("lblLogout");
            NSW.Data.LabelText displayLang = new NSW.Data.LabelText("lblDisplayLanguage");
            NSW.Data.LabelText english = new NSW.Data.LabelText("chkEnglish");
            NSW.Data.LabelText japanese = new NSW.Data.LabelText("chkJanapese");
            NSW.Data.LabelText footer = new NSW.Data.LabelText("lblFooter");
            NSW.Data.LabelText admin = new NSW.Data.LabelText("btnAdmin");
            NSW.Data.LabelText label = new NSW.Data.LabelText("btnLabel");
            NSW.Data.LabelText member = new NSW.Data.LabelText("btnMember");
            NSW.Data.LabelText password = new NSW.Data.LabelText("btnPassword");
            NSW.Data.LabelText profile = new NSW.Data.LabelText("btnProfile");
            if (chkJanapese.Checked)
                Session["DisplayLanguage"] = "Japanese";
            if (chkEnglish.Checked)
                Session["DisplayLanguage"] = "English";
            // now set all the label and text values
            switch (Session["DisplayLanguage"].ToString())
            {
                case "English":
                    {
                        if (!this.chkEnglish.Checked)
                            this.chkEnglish.Checked = true;
                        break;
                    }
                case "Japanese":
                    {
                        if (!this.chkJanapese.Checked)
                            this.chkJanapese.Checked = true;
                        break;
                    }
            }
            // now set all the label text
            // title of the page
            lblTitle.Text = title.Text;
            // Welcome text
            Label newLabel = (Label)this.HeadLoginView.FindControl("lblWelcome");
            if (newLabel != null)
                newLabel.Text = welcome.Text;
            // Title bar button "Login"
            newLabel = (Label)this.HeadLoginView.FindControl("lblLogin");
            if (newLabel != null)
                newLabel.Text = login.Text;
            // logout button
            if (NSW.Data.Cache.Get("User") != null)
            {
                LoginStatus newStatus = (LoginStatus)this.HeadLoginView.FindControl("HeadLoginStatus");
                if (newStatus != null)
                    newStatus.LogoutText = logout.Text;
            }
            // Menu bar
            MenuItem searchItem = new MenuItem(search.Text, null, null, "~/Search.aspx");
            MenuItem homeItem = new MenuItem(home.Text, null, null, "~/Default.aspx");
            this.NavigationMenu.Items.Clear();
            this.NavigationMenu.Items.Add(homeItem);
            this.NavigationMenu.Items.Add(searchItem);
            NSW.Data.User cacheUser = (NSW.Data.User)Cache["User"];
            if (cacheUser != null)
            {
                // admin menu
                if (cacheUser.UserRole == Role.Admin)
                {
                    MenuItem adminItem = new MenuItem(admin.Text, null, null, null);
                    MenuItem labelItem = new MenuItem(label.Text, null, null, "~/Admin/LabelText.aspx");
                    adminItem.ChildItems.Add(labelItem);
                    this.NavigationMenu.Items.Add(adminItem);
                }
                // member menu
                if (cacheUser.UserRole == Role.Member | cacheUser.UserRole == Role.Admin)
                {
                    MenuItem memberItem = new MenuItem(member.Text, null, null, null);
                    MenuItem passwordItem = new MenuItem(password.Text, null, null, "~/Account/ChangePassword.aspx");
                    MenuItem accountItem = new MenuItem(profile.Text, null, null, "~/Account/Profile.aspx");
                    memberItem.ChildItems.Add(passwordItem);
                    memberItem.ChildItems.Add(accountItem);
                    this.NavigationMenu.Items.Add(memberItem);
                }
            }
            // language chooser
            this.lblDisplayLanguage.Text = displayLang.Text;
            this.chkEnglish.Text = english.Text;
            this.chkJanapese.Text = japanese.Text;
            // footer
            this.lblFooter.Text = footer.Text;

        }
    }
}
