using System;
using System.Data;
using System.Data.SqlClient;
using System.Web.UI.WebControls;

namespace NSW.Admin
{
    public partial class LabelText : System.Web.UI.Page
    {
        SqlConnection labelConn = new SqlConnection(NSW.Info.ConnectionInfo.ConnectionString);
        SqlCommand labelComm;
        string selectedItem = "";

        protected void Page_Load(object sender, EventArgs e)
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "LabelText.Page_Load", "Here", LogEnum.Debug);
            if (!IsPostBack)
                LoadDropDownList();
            // load all text values
            this.LoadLabelValues();
        }

        protected void FinishClick(object sender, WizardNavigationEventArgs e)
        {
            Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "LabelText.FinishClick", "Here", LogEnum.Debug);
            try
            {
                // check and save the values
                labelComm = labelConn.CreateCommand();
                labelComm.CommandType = CommandType.StoredProcedure;
                labelComm.CommandText = "modifyLabelText";
                SqlParameter param = new SqlParameter("@ID", this.ddlLabelID.SelectedItem.Text.ToString());
                labelComm.Parameters.Add(param);
                param = new SqlParameter("@english", this.txtEnglish.Text.ToString());
                labelComm.Parameters.Add(param);
                if (this.txtJapanese.Text.Length > 0)
                    param = new SqlParameter("@japanese", this.txtJapanese.Text.ToString());
                else
                    param = new SqlParameter("@japanese", null);
                labelComm.Parameters.Add(param);
                labelConn.Open();
                int result = labelComm.ExecuteNonQuery();
                labelConn.Close();
                this.LabelTextErrorMessage.Text = NSW.Data.LabelText.Text("LabelText.LabelEntrySuccess");
            }
            catch (Exception x)
            {
                Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "LabelText.FinishClick", x, LogEnum.Critical);
            }
        }

        protected void CancelClick(object sender, EventArgs e)
        {
            // clear the form and return the user to the main webform
            string url = "~/Default.aspx";
            Response.Redirect(url);
        }

        protected void ddlLabelID_SelectedIndexChanged(object sender, EventArgs e)
        {
            selectedItem = ddlLabelID.SelectedItem.Text.ToString();
            try
            {
                // change the values of the form
                labelComm = labelConn.CreateCommand();
                labelComm.CommandType = CommandType.Text;
                labelComm.CommandText = "Select * from tblLabelText where fldLabel_ID='" + selectedItem + "'";
                DataSet ds = new DataSet();
                SqlDataAdapter adap = new SqlDataAdapter(labelComm);
                labelConn.Open();
                adap.Fill(ds);
                labelConn.Close();
                // load the values into form controls
                DataRow dr = ds.Tables[0].Rows[0];
                string eng = dr["fldLabel_English"].ToString();
                string jap = dr["fldLabel_Japanese"].ToString();
                this.txtEnglish.Text = eng;
                this.txtJapanese.Text = jap;
                // re-load the drop down list
                LoadDropDownList();
            }
            catch (Exception x)
            {
                Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "LabelText.ddlLabelID_SelectedIndexChanged", x, LogEnum.Critical);
            }
        }

        private void LoadDropDownList()
        {
            try
            {
                // load the dropdown values
                labelComm = labelConn.CreateCommand();
                labelComm.CommandType = CommandType.Text;
                labelComm.CommandText = "Select * from tblLabelText order by fldLabel_ID";
                DataSet ds = new DataSet();
                SqlDataAdapter adap = new SqlDataAdapter(labelComm);
                labelConn.Open();
                adap.Fill(ds);
                labelConn.Close();
                ddlLabelID.Items.Clear();
                ddlLabelID.Items.Add("Select One...");
                for (int i = 0; i <= ds.Tables[0].Rows.Count - 1; i++)
                {
                    DataRow dr = ds.Tables[0].Rows[i];
                    // add the item
                    ddlLabelID.Items.Add(dr["fldLabel_ID"].ToString());
                    // if no japanese, color it red
                    if (dr["fldLabel_Japanese"].ToString() == string.Empty)
                        ddlLabelID.Items[i + 1].Attributes.Add("style", "color:red");
                }
                if (selectedItem != string.Empty)
                    ddlLabelID.SelectedItem.Text = selectedItem;
            }
            catch (Exception x)
            {
                Log.WriteToLog(NSW.Info.ProjectInfo.ProjectLogType, "LabelText.LoadDropDownList", x, LogEnum.Critical);
            }
        }

        private void LoadLabelValues()
        {
            // now set the text values
            this.lbl_ddlLabelID.Text = NSW.Data.LabelText.Text("LabelText.ddlLabelID");
            this.lbl_txtEnglish.Text = NSW.Data.LabelText.Text("LabelText.txtEnglish");
            this.lbl_txtJapanese.Text = NSW.Data.LabelText.Text("LabelText.txtJapanese");
            this.LabelTextWizard.FinishCompleteButtonText = NSW.Data.LabelText.Text("LabelText.FinishButton");
            this.EnglishRequired.Text = NSW.Data.LabelText.Text("LabelText.EnglishRequiredMessage");
        }
    }
}